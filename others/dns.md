
# 必要なパッケージの導入
```$ sudo apt install bind9 bind9utils```


```$ sudo systemctl stop bind9.service # システムを設定中は動作を止めておく```


インストールされた設定ファイルは、/etc/bind に集約されている。
```
mit@bridget:/etc/bind$ pwd
/etc/bind
mit@bridget:/etc/bind$ ls -la
total 56
drwxr-sr-x  2 root bind 4096 Aug  7 18:43 .
drwxr-xr-x 98 root root 4096 Aug  7 18:43 ..
-rw-r--r--  1 root root 2761 May 18 17:02 bind.keys
-rw-r--r--  1 root root  353 May 18 17:02 db.empty
-rw-r--r--  1 root root  270 May 18 17:02 db.local
-rw-r--r--  1 root root  237 May 18 17:02 db.0
-rw-r--r--  1 root root  271 May 18 17:02 db.127
-rw-r--r--  1 root root  237 May 18 17:02 db.255
-rw-r--r--  1 root bind  463 May 18 17:02 named.conf               # 設定ファイルの大本 触らない
-rw-r--r--  1 root bind  165 May 18 17:02 named.conf.local         # ローカルの設定ファイル
-rw-r--r--  1 root bind  846 May 18 17:02 named.conf.options       # オプション設定
-rw-r--r--  1 root bind  498 May 18 17:02 named.conf.default-zones # デフォルトの設定 触らない
-rw-r-----  1 bind bind   77 Aug  7 18:43 rndc.key
-rw-r--r--  1 root root 1317 May 18 17:02 zones.rfc1918
```

# 設定ファイル
DHCP で割り振られたDNS サーバを確認しておく
```
mit@bridget:/etc/bind$ cat /etc/resolv.conf
nameserver 157.7.180.133
nameserver 163.44.76.148
```

- 157.7.180.133
- 163.44.76.148

このアドレスは named.conf.options の forwarders で使用する。

named.conf.* の設定は、 ";" で区切りを行う これよく忘れるので注意。後述の/usr/sbin/named-checkconf を使う事。

```
mit@bridget:/etc/bind$ cat named.conf.options
acl "internalnet" {
        172.16.0.0/12;
        192.168.0.0/16;
        2400:8500:1301:737:133:130:101:77;
        2400:8500:1301:737:a133:130:101:770;
        2400:8500:1301:737:a133:130:101:771;
        2400:8500:1301:737:a133:130:101:772;
        2400:8500:1301:737:a133:130:101:773;
        2400:8500:1301:737:a133:130:101:774;
        2400:8500:1301:737:a133:130:101:775;
        2400:8500:1301:737:a133:130:101:776;
        2400:8500:1301:737:a133:130:101:777;
        2400:8500:1301:737:a133:130:101:778;
        2400:8500:1301:737:a133:130:101:779;
        2400:8500:1301:737:a133:130:101:77a;
        2400:8500:1301:737:a133:130:101:77b;
        2400:8500:1301:737:a133:130:101:77c;
        2400:8500:1301:737:a133:130:101:77d;
        2400:8500:1301:737:a133:130:101:77e;
        2400:8500:1301:737:a133:130:101:77f;
};

options {
        directory "/var/cache/bind";

        // If there is a firewall between you and nameservers you want
        // to talk to, you may need to fix the firewall to allow multiple
        // ports to talk.  See http://www.kb.cert.org/vuls/id/800113

        query-source address 133.130.101.77 port *;
        query-source-v6 address 2400:8500:1301:737:133:130:101:77 port *;

        listen-on port 53{
                127.0.0.1;
                172.17.1.1;
        };

        // If your ISP provided one or more IP addresses for stable
        // nameservers, you probably want to use them as forwarders.
        // Uncomment the following block, and insert the addresses replacing
        // the all-0's placeholder.

        // forwarders {
        //      0.0.0.0;
        // };
        forwarders {
                157.7.180.133;
                163.44.76.148;
        };

        allow-transfer    { none; };
        allow-query-cache { localhost; internalnet; };
        allow-query       { localhost; internalnet; };
        recursion yes;
        allow-recursion   { localhost; internalnet; };
        //========================================================================
        // If BIND logs error messages about the root key being expired,
        // you will need to update your keys.  See https://www.isc.org/bind-keys
        //========================================================================
        dnssec-validation auto;

        listen-on-v6 { ::1; };
};
```

IPv6 は ローカルループバックアドレスのみ見る（nsupdate が server localhost を指定することができるようにするために）


```
mit@bridget:/etc/bind$ cat named.conf.local
//
// Do any local configuration here
//

// Consider adding the 1918 zones here, if they are not used in your
// organization
//include "/etc/bind/zones.rfc1918";

zone "vpn.iogilab.net" {
        type master;
        file "/var/cache/bind/db.vpn.iogilab.net";
        allow-update { localhost; };
};

```


# ゾーンファイルの作成 
注意： ゾーンファイルは、dynamic DNS ( nsupdate ) を用いてアップデートするので、named が書き込めないといけない。
このために、/var/cache/bind に ゾーンファイルを置く。
さもないと appArmor によって、書き込みを拒否される。実際の設定は appArmorのプロファイルを確認してください。


はじめから作ってもいいのだが、db.empty からコピーして使う 
```$ sudo cp db.empty /var/cache/bind/db.vpn.iogilab.net```

```
mit@bridget:/var/cache/bind$ cat db.vpn.iogilab.net
; BIND reverse data file for empty rfc1918 zone
;
; DO NOT EDIT THIS FILE - it is used for multiple zones.
; Instead, copy it, edit named.conf, and use that copy.
;
$TTL    86400
@       IN      SOA     localhost. root.localhost. (
                              1         ; Serial
                         604800         ; Refresh
                          86400         ; Retry
                        2419200         ; Expire
                          86400 )       ; Negative Cache TTL
;
@       IN      NS      localhost.
```

db.vpn.iogilab.net は dynamic dns で更新するつもりなので、所有権をbind.bind へ変更しておく
```
mit@bridget:/var/cache/bind$ sudo chown bind.bind db.vpn.iogilab.net
```

named.conf.local にゾーンを追加
zone の後ろはドメイン名 プライマリでファイルはさっきコピーして作ったファイルへ
```
mit@bridget:/etc/bind$ cat named.conf.local
//
// Do any local configuration here
//

// Consider adding the 1918 zones here, if they are not used in your
// organization
//include "/etc/bind/zones.rfc1918";

zone "vpn.iogilab.net" {
        type master;
        file "/var/cache/db.vpn.iogilab.net";
        allow-update { localhost; };
};
```

一通り設定を終えたら ```named-checkconf``` を使用して、確認のこと。
```
$ sudo named-checkconf
$
```
問題無ければ何も出力されない。

# 起動
```
mit@bridget:/etc/bind$ sudo systemctl start bind9.service
```

# チェック

- domain が、当該のIPに対して「のみ」 listen しているかどうかのチェック

```
mit@bridget:/etc/bind$ netstat -a | more
Active Internet connections (servers and established)
Proto Recv-Q Send-Q Local Address           Foreign Address         State
tcp        0      0 172.17.1.1:domain       0.0.0.0:*               LISTEN
tcp        0      0 bridget.iogilab.:domain 0.0.0.0:*               LISTEN
tcp        0      0 bridget.iogilab.net:ssh 0.0.0.0:*               LISTEN
...
```

- DNSのforwader の設定ができているかどうかのチェック
```
mit@bridget:/etc/bind$ dig @127.0.0.1 www.google.com

; <<>> DiG 9.11.5-P4-5.1+deb10u1-Debian <<>> @127.0.0.1 www.google.com
; (1 server found)
;; global options: +cmd
...
```

- DynamicDNS の nsupdate での更新テスト
```
mit@bridget:/var/cache/bind$ nsupdate -d
> server 127.0.0.1
> update add bridget.vpn.iogilab.net. 3600 IN A 172.17.1.1
> send
Reply from SOA query:
;; ->>HEADER<<- opcode: QUERY, status: NOERROR, id:  54193
;; flags: qr aa ra; QUESTION: 1, ANSWER: 0, AUTHORITY: 1, ADDITIONAL: 0
;; QUESTION SECTION:
;bridget.vpn.iogilab.net.       IN      SOA

;; AUTHORITY SECTION:
vpn.iogilab.net.        86400   IN      SOA     localhost. root.localhost. 4 604800 86400 2419200 86400

Found zone name: vpn.iogilab.net
The master is: localhost
Sending update to 127.0.0.1#53
Outgoing update query:
;; ->>HEADER<<- opcode: UPDATE, status: NOERROR, id:  38113
;; flags:; ZONE: 1, PREREQ: 0, UPDATE: 1, ADDITIONAL: 0
;; UPDATE SECTION:
bridget.vpn.iogilab.net. 3600   IN      A       172.17.1.1


Reply from update query:
;; ->>HEADER<<- opcode: UPDATE, status: NOERROR, id:  38113
;; flags: qr; ZONE: 1, PREREQ: 0, UPDATE: 0, ADDITIONAL: 0
;; ZONE SECTION:
;vpn.iogilab.net.               IN      SOA

> quit
```

更新ができることが確認できたのならば、 dig で引けることを確認

```
mit@bridget:/var/cache/bind$ dig @127.0.0.1 bridget.vpn.iogilab.net

; <<>> DiG 9.11.5-P4-5.1+deb10u1-Debian <<>> @127.0.0.1 bridget.vpn.iogilab.net
; (1 server found)
;; global options: +cmd
;; Got answer:
;; ->>HEADER<<- opcode: QUERY, status: NOERROR, id: 21995
;; flags: qr aa rd ra; QUERY: 1, ANSWER: 1, AUTHORITY: 1, ADDITIONAL: 3

;; OPT PSEUDOSECTION:
; EDNS: version: 0, flags:; udp: 4096
; COOKIE: 42ec55e487128fff305d16c25f2d35f27c0aff6974a56815 (good)
;; QUESTION SECTION:
;bridget.vpn.iogilab.net.       IN      A

;; ANSWER SECTION:
bridget.vpn.iogilab.net. 3600   IN      A       172.17.1.1

;; AUTHORITY SECTION:
vpn.iogilab.net.        86400   IN      NS      localhost.

;; ADDITIONAL SECTION:
localhost.              604800  IN      A       127.0.0.1
localhost.              604800  IN      AAAA    ::1

;; Query time: 0 msec
;; SERVER: 127.0.0.1#53(127.0.0.1)
;; WHEN: Fri Aug 07 20:07:30 JST 2020
;; MSG SIZE  rcvd: 163

```

以上で、Dyanamic DNS (nsupdate) でDNS レコードの修正ができるように設定ができた。




